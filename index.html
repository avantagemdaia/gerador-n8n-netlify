<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>n8n Configuration Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7.24.7/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    function App() {
      const [formData, setFormData] = React.useState({
        projectName: '',
        editorHost: '',
        webhookHost: '',
        redisPassword: '',
        postgresPassword: '',
        encryptionKey: ''
      });

      const [infraConfig, setInfraConfig] = React.useState('');
      const [servicesConfig, setServicesConfig] = React.useState('');

      const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
      };

      const generateConfigs = () => {
        const infra = {
          services: [
            {
              type: "postgres",
              data: {
                projectName: formData.projectName,
                serviceName: "n8n_postgres",
                image: "postgres:16",
                password: formData.postgresPassword
              }
            },
            {
              type: "redis",
              data: {
                projectName: formData.projectName,
                serviceName: "redis_n8n",
                image: "redis:7",
                password: formData.redisPassword
              }
            }
          ]
        };

        const commonEnv = `DB_POSTGRESDB_DATABASE=$(PROJECT_NAME)\r\nDB_POSTGRESDB_HOST=$(PROJECT_NAME)_n8n_postgres\r\nDB_POSTGRESDB_PASSWORD=${formData.postgresPassword}\r\nDB_POSTGRESDB_PORT=5432\r\nDB_POSTGRESDB_USER=postgres\r\nDB_TYPE=postgresdb\r\nQUEUE_BULL_REDIS_HOST=$(PROJECT_NAME)_redis_n8n\r\nQUEUE_BULL_REDIS_PASSWORD=${formData.redisPassword}\r\nQUEUE_BULL_REDIS_PORT=6379\r\nEXECUTIONS_MODE=queue\r\nEXECUTIONS_DATA_MAX_AGE=336\r\nEXECUTIONS_DATA_PRUNE=true\r\nGENERIC_TIMEZONE=America/Sao_Paulo\r\nN8N_DIAGNOSTICS_ENABLED=false\r\nN8N_EDITOR_BASE_URL=https://${formData.editorHost}/\r\nN8N_ENCRYPTION_KEY=${formData.encryptionKey}\r\nN8N_HOST=${formData.editorHost}/\r\nN8N_PROTOCOL=https\r\nNODE_ENV=production\r\nNODE_FUNCTION_ALLOW_EXTERNAL=moment,lodash,moment-with-locales\r\nN8N_LOG_LEVEL=debug\r\nN8N_LOG_OUTPUT=file,console\r\nN8N_LOG_FILE_LOCATION=/home/node/.n8n/logs/n8n-01.log\r\nTZ=America/Sao_Paulo\r\nWEBHOOK_URL=https://${formData.webhookHost}/`;

        const services = {
          services: [
            {
              type: "app",
              data: {
                projectName: formData.projectName,
                serviceName: "n8n_editor",
                source: { type: "image", image: "n8nio/n8n:latest" },
                env: commonEnv,
                deploy: { replicas: 1, command: "n8n start", zeroDowntime: true },
                domains: [{ host: formData.editorHost, https: true, port: 5678, path: "/", wildcard: false }],
                mounts: [{ type: "volume", name: "data", mountPath: "/home/node/.n8n" }]
              }
            },
            {
              type: "app",
              data: {
                projectName: formData.projectName,
                serviceName: "n8n_webhook",
                source: { type: "image", image: "n8nio/n8n:latest" },
                env: commonEnv,
                deploy: { replicas: 1, command: "n8n webhook", zeroDowntime: true },
                domains: [{ host: formData.webhookHost, https: true, port: 5678, path: "/", wildcard: false }],
                mounts: [{ type: "volume", name: "data", mountPath: "/home/node/.n8n" }]
              }
            },
            {
              type: "app",
              data: {
                projectName: formData.projectName,
                serviceName: "n8n_worker",
                source: { type: "image", image: "n8nio/n8n:latest" },
                env: commonEnv,
                deploy: { replicas: 1, command: "n8n worker --concurrency=5", zeroDowntime: true },
                mounts: [{ type: "volume", name: "data", mountPath: "/home/node/.n8n" }]
              }
            }
          ]
        };

        setInfraConfig(JSON.stringify(infra, null, 2));
        setServicesConfig(JSON.stringify(services, null, 2));
      };

      const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text);
        alert('Configuration copied to clipboard!');
      };

      return (
        <div className="container mx-auto p-4 max-w-4xl">
          <h1 className="text-2xl font-bold mb-4">n8n Configuration Generator</h1>
          
          <div className="grid grid-cols-1 gap-4 mb-6">
            <input
              type="text"
              name="projectName"
              placeholder="Project Name (e.g., p2)"
              value={formData.projectName}
              onChange={handleInputChange}
              className="p-2 border rounded"
            />
            <input
              type="text"
              name="editorHost"
              placeholder="Editor Host (e.g., n8neditor.google.com)"
              value={formData.editorHost}
              onChange={handleInputChange}
              className="p-2 border rounded"
            />
            <input
              type="text"
              name="webhookHost"
              placeholder="Webhook Host (e.g., n8nwebhook.google.com)"
              value={formData.webhookHost}
              onChange={handleInputChange}
              className="p-2 border rounded"
            />
            <input
              type="password"
              name="redisPassword"
              placeholder="Redis Password"
              value={formData.redisPassword}
              onChange={handleInputChange}
              className="p-2 border rounded"
            />
            <input
              type="password"
              name="postgresPassword"
              placeholder="PostgreSQL Password"
              value={formData.postgresPassword}
              onChange={handleInputChange}
              className="p-2 border rounded"
            />
            <input
              type="password"
              name="encryptionKey"
              placeholder="Encryption Key"
              value={formData.encryptionKey}
              onChange={handleInputChange}
              className="p-2 border rounded"
            />
          </div>

          <button
            onClick={generateConfigs}
            className="bg-blue-500 text-white p-2 rounded mb-6 hover:bg-blue-600"
          >
            Generate Configurations
          </button>

          {infraConfig && (
            <div className="mb-6">
              <h2 className="text-xl font-semibold mb-2">Infrastructure Configuration (PostgreSQL and Redis)</h2>
              <pre className="bg-gray-100 p-4 rounded overflow-auto">
                {infraConfig}
              </pre>
              <button
                onClick={() => copyToClipboard(infraConfig)}
                className="bg-green-500 text-white p-2 rounded mt-2 hover:bg-green-600"
              >
                Copy Infrastructure Config
              </button>
            </div>
          )}

          {servicesConfig && (
            <div>
              <h2 className="text-xl font-semibold mb-2">Services Configuration (Editor, Webhook, Worker)</h2>
              <pre className="bg-gray-100 p-4 rounded overflow-auto">
                {servicesConfig}
              </pre>
              <button
                onClick={() => copyToClipboard(servicesConfig)}
                className="bg-green-500 text-white p-2 rounded mt-2 hover:bg-green-600"
              >
                Copy Services Config
              </button>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>